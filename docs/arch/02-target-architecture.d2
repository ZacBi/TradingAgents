direction: down

title: 升级后 TradingAgents 架构 {
  near: top-center
  shape: text
  style.font-size: 24
  style.bold: true
}

Observe: 可观测层 - Langfuse (自托管) {
  style.fill: "#e8eaf6"
  style.stroke: "#3f51b5"
  Tracing: Tracing: 全链路追踪
  PromptMgmt: Prompt Management: 版本控制 + A/B测试
  CostTrack: Cost Tracking: 每节点Token消耗
  Eval: Evaluation: 决策质量评分
}

LLMGateway: LLM网关层 - LiteLLM {
  style.fill: "#fce4ec"
  style.stroke: "#e91e63"
  direction: right
  Google: Google Gemini
  Bailian: 百炼 Qwen/DS
  OpenRouter: OpenRouter GPT/Claude
  Ollama: Ollama 本地模型
  UnifiedAPI: 统一API接口 {
    desc: 自动fallback / 成本路由 / 负载均衡
  }
  Google -> UnifiedAPI
  Bailian -> UnifiedAPI
  OpenRouter -> UnifiedAPI
  Ollama -> UnifiedAPI
}

DataLayer: 数据层 {
  style.fill: "#fff3e0"
  style.stroke: "#ff9800"
  Free: 免费数据源 {
    YF: Yahoo Finance (主力)
    FRED: FRED (宏观经济)
    FH: Finnhub (新闻)
    RD: Reddit (情绪)
  }
  Paid: 付费数据源 {
    style.fill: "#fff8e1"
    Longport: 长桥Longport API {
      desc: 港/美/A股实时行情+交易
    }
  }
}

AgentOrch: Agent编排层 - LangGraph 1.0 {
  style.fill: "#e8f5e9"
  style.stroke: "#4caf50"
  
  Features: 特性 {
    shape: text
    style.font-size: 12
    desc: Checkpointing | Subgraph | Human-in-the-Loop | Streaming
  }

  Phase1: 阶段1: 数据收集 (并行) {
    style.fill: "#c8e6c9"
    MA: Market Analyst
    NA: News Analyst
    SA: Social Analyst
    FA: Fundamentals
    Reports: 4份分析报告
    DeepRes: Deep Research Agent (可选)
    DeepReport: 深度研究报告
    Earnings: Earnings Tracker (可选)
    EarningsAlert: 财报预警
    MA -> Reports
    NA -> Reports
    SA -> Reports
    FA -> Reports
    DeepRes -> DeepReport
    Earnings -> EarningsAlert
  }

  Phase2: 阶段2: 多视角分析 {
    style.fill: "#a5d6a7"
    TrendTeam: 趋势/投机团队 {
      Bull: Bull Researcher
      Bear: Bear Researcher
      Bull -> Bear: 动态收敛辩论
      Bear -> Bull: 反馈调整
    }
    ValueTeam: 价值投资团队 (动态选择N个专家) {
      Buffett: Buffett Agent
      Munger: Munger Agent
      Lynch: Lynch Agent
      Livermore: Livermore Agent
      MoreExperts: ... (可扩展注册)
    }
    RM: Research Manager (综合裁决)
    TrendTeam -> RM
    ValueTeam -> RM
  }

  Phase3: 阶段3: 风险评估 + 执行 {
    style.fill: "#81c784"
    Trader
    RiskTeam: Risk Team (动态收敛辩论)
    RiskMgr: Risk Manager
    FinalDecision: BUY/SELL/HOLD + 仓位 + 止损 {
      shape: parallelogram
    }
    Trader -> RiskTeam -> RiskMgr -> FinalDecision
  }

  Phase1 -> Phase2 -> Phase3
}

Persist: 持久化层 {
  style.fill: "#f3e5f5"
  style.stroke: "#9c27b0"
  SQLiteDB: SQLite 数据库 {
    Positions: positions (持仓)
    Trades: trades (交易记录)
    Decisions: agent_decisions (决策日志)
    NAV: daily_nav (净值曲线)
  }
  ChromaDBE: ChromaDB (增强) {
    Working: 工作记忆 (当日)
    Episodic: 情节记忆 (历史案例)
    Semantic: 语义记忆 (市场规律)
  }
  Checkpoints: LangGraph Checkpoints {
    desc: 状态快照，支持回滚/重放
  }
}

Display: 展示层 (渐进式) {
  style.fill: "#e0f7fa"
  style.stroke: "#00bcd4"
  direction: right
  CLI: CLI (已有) -> Streamlit: Streamlit Dashboard -> WebApp: FastAPI + React
}

# 连接关系
Observe -> AgentOrch: 监控所有Agent节点
LLMGateway.UnifiedAPI -> AgentOrch
DataLayer -> AgentOrch
AgentOrch -> Persist
Persist -> Display